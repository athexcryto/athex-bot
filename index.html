<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; background: radial-gradient(circle, #1a2a6c, #b21f1f, #fdbb2d); color: white; text-align: center; overflow: hidden; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        canvas { display: block; margin: 0 auto; }
        #ui { position: absolute; top: 10px; width: 100%; pointer-events: none; z-index: 10; }
        #menu { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.95); padding: 30px; border-radius: 20px; display: none; pointer-events: auto; border: 2px solid #00ffcc; width: 80%; z-index: 100; }
        button { background: #00ffcc; color: #000; border: none; padding: 15px 40px; border-radius: 50px; font-size: 22px; font-weight: bold; cursor: pointer; box-shadow: 0 0 15px #00ffcc; }
        .token-amt { color: #00ffcc; font-size: 40px; font-weight: 900; display: block; margin: 10px 0; }
    </style>
</head>
<body>
    <div id="ui">
        <h2>Target: <span id="colorName">...</span></h2>
        <div style="font-size: 20px; font-weight: bold;">Points: <span id="scoreVal">0</span> | Time: <span id="timer">30</span>s</div>
        <div id="comboDisplay" style="color:#fff; font-style: italic;"></div>
    </div>

    <div id="menu">
        <h1>TIME UP!</h1>
        <p>Final Score: <span id="finalScore">0</span></p>
        <div>You earned:<br><span class="token-amt" id="athexEarned">0 ATHEX</span></div>
        <button onclick="startGame()">PLAY AGAIN</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let score, timeLeft, objects, combo, gameActive, speedMult;
        const colors = ['#00d2ff', '#ff4b2b', '#00ff87', '#f9d423']; 
        const names = ['BLUE', 'RED', 'GREEN', 'YELLOW'];
        let targetIdx = 0;

        function drawLeaf(x, y, size, color) {
            ctx.save();
            ctx.translate(x, y);
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.moveTo(0, -size);
            ctx.quadraticCurveTo(size, -size/2, 0, size); 
            ctx.quadraticCurveTo(-size, -size/2, 0, -size); 
            ctx.fill();
            ctx.restore();
        }

        function startGame() {
            score = 0; timeLeft = 30; objects = []; combo = 0;
            gameActive = true; speedMult = 1.3;
            targetIdx = Math.floor(Math.random() * 4);
            document.getElementById('colorName').innerText = names[targetIdx];
            document.getElementById('colorName').style.color = colors[targetIdx];
            document.getElementById('menu').style.display = 'none';
            update();
            timerLoop();
        }

        function update() {
            if (!gameActive) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            speedMult = 1.3 + (30 - timeLeft) * 0.08;

            if (Math.random() < 0.05) {
                let xPos = Math.random() * (canvas.width - 60) + 30;
                if (objects.every(o => Math.abs(o.x - xPos) > 50)) {
                    objects.push({ x: xPos, y: -50, colorIdx: Math.floor(Math.random()*4), speed: (2.5 + Math.random()*2) * speedMult });
                }
            }

            objects.forEach((obj, i) => {
                obj.y += obj.speed;
                drawLeaf(obj.x, obj.y, 28, colors[obj.colorIdx]);

                if (obj.y > canvas.height + 60) {
                    if (obj.colorIdx === targetIdx) { 
                        score = Math.max(0, score - 1); 
                        combo = 0; 
                    }
                    objects.splice(i, 1);
                }
            });

            document.getElementById('scoreVal').innerText = score;
            requestAnimationFrame(update);
        }

        // STRICT INPUT: Only fires on actual Down-Click or Touch
        function handleAction(e) {
            if (!gameActive) return;
            e.preventDefault(); // Prevents accidental scrolling/zooming
            
            // Get exact coordinates of the CLICK, not the cursor movement
            const rect = canvas.getBoundingClientRect();
            const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
            const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;

            let hitSomething = false;

            for (let i = objects.length - 1; i >= 0; i--) {
                const obj = objects[i];
                const dist = Math.hypot(x - obj.x, y - obj.y);
                
                if (dist < 45) { // Hit box size
                    hitSomething = true;
                    if (obj.colorIdx === targetIdx) {
                        combo++;
                        let mult = combo >= 10 ? 3 : (combo >= 5 ? 2 : 1);
                        score += (1 * mult);
                    } else {
                        score = Math.max(0, score - 2);
                        combo = 0;
                    }
                    objects.splice(i, 1);
                    break; // Only hit one leaf per click
                }
            }
        }

        // We use 'mousedown' and 'touchstart' ONLY. No 'mousemove' or 'mouseover'.
        canvas.addEventListener('mousedown', handleAction);
        canvas.addEventListener('touchstart', handleAction, {passive: false});

        function timerLoop() {
            const count = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').innerText = timeLeft;
                if (timeLeft <= 0) { 
                    clearInterval(count); 
                    gameActive = false;
                    endGame(); 
                }
            }, 1000);
        }

        function endGame() {
            document.getElementById('menu').style.display = 'block';
            document.getElementById('finalScore').innerText = score;
            // 1 POINT = 1 TOKEN
            document.getElementById('athexEarned').innerText = score + " ATHEX";
        }

        startGame();
    </script>
</body>
</html>
