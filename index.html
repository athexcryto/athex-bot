<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; background: radial-gradient(circle, #0f2027, #203a43, #2c5364); color: white; text-align: center; overflow: hidden; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        canvas { display: block; margin: 0 auto; }
        #ui { position: absolute; top: 10px; width: 100%; pointer-events: none; }
        #menu { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); padding: 30px; border-radius: 20px; display: none; pointer-events: auto; border: 1px solid #00ffcc; width: 85%; }
        button { background: #00ffcc; color: #000; border: none; padding: 15px 30px; border-radius: 50px; font-size: 20px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .token-text { color: #00ffcc; font-size: 35px; font-weight: 900; display: block; }
    </style>
</head>
<body>
    <div id="ui">
        <h2>Target: <span id="colorName">...</span></h2>
        <div style="font-size: 18px;">ATHEX: <span id="scoreVal">0</span> | Time: <span id="timer">30</span>s</div>
        <div id="comboDisplay" style="color:#ffd700; font-size: 24px; font-weight: bold;"></div>
    </div>

    <div id="menu">
        <h1 id="statusText">ROUND ENDED</h1>
        <p>Total Score: <span id="finalScore">0</span></p>
        <div id="rewardSection">You earned:<br><span class="token-text" id="athexEarned">0 ATHEX</span></div>
        <button onclick="startGame()">PLAY AGAIN</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let score, timeLeft, objects, combo, gameActive, speedMult;
        const colors = ['#00d2ff', '#ff4b2b', '#00ff87', '#f9d423']; // Blue, Red, Green, Yellow
        const names = ['BLUE', 'RED', 'GREEN', 'YELLOW'];
        let targetIdx = 0;

        // Draw a realistic Pointed Leaf
        function drawLeaf(x, y, size, color) {
            ctx.save();
            ctx.translate(x, y);
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.moveTo(0, -size);
            ctx.quadraticCurveTo(size, -size/2, 0, size); // Right side
            ctx.quadraticCurveTo(-size, -size/2, 0, -size); // Left side
            ctx.fill();
            ctx.strokeStyle = "rgba(0,0,0,0.2)";
            ctx.lineWidth = 1;
            ctx.stroke();
            ctx.restore();
        }

        function startGame() {
            score = 0; timeLeft = 30; objects = []; combo = 0; // Increased time to 30s
            gameActive = true; speedMult = 1.2;
            targetIdx = Math.floor(Math.random() * colors.length);
            document.getElementById('colorName').innerText = names[targetIdx];
            document.getElementById('colorName').style.color = colors[targetIdx];
            document.getElementById('menu').style.display = 'none';
            update();
            timerLoop();
        }

        function update() {
            if (!gameActive) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Smoother speed ramping
            speedMult = 1.2 + (30 - timeLeft) * 0.1;

            if (Math.random() < 0.04) {
                let xPos = Math.random() * (canvas.width - 50) + 25;
                // Avoid overlapping
                if (objects.every(o => Math.abs(o.x - xPos) > 40)) {
                    objects.push({ x: xPos, y: -50, colorIdx: Math.floor(Math.random()*4), speed: (2 + Math.random()*2) * speedMult });
                }
            }

            objects.forEach((obj, i) => {
                obj.y += obj.speed;
                drawLeaf(obj.x, obj.y, 25, colors[obj.colorIdx]);

                if (obj.y > canvas.height + 50) {
                    if (obj.colorIdx === targetIdx) { score = Math.max(0, score - 1); combo = 0; }
                    objects.splice(i, 1);
                }
            });

            document.getElementById('scoreVal').innerText = score;
            document.getElementById('comboDisplay').innerText = combo >= 5 ? `X${Math.floor(combo/5)+1} COMBO!` : "";
            requestAnimationFrame(update);
        }

        function handleTap(e) {
            if (!gameActive) return;
            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const y = e.touches ? e.touches[0].clientY : e.clientY;

            objects.forEach((obj, i) => {
                if (Math.hypot(x - obj.x, y - obj.y) < 40) {
                    if (obj.colorIdx === targetIdx) {
                        combo++;
                        let mult = combo >= 10 ? 3 : (combo >= 5 ? 2 : 1);
                        score += (1 * mult);
                    } else {
                        score = Math.max(0, score - 2);
                        combo = 0;
                    }
                    objects.splice(i, 1);
                }
            });
        }

        canvas.addEventListener('touchstart', handleTap);
        canvas.addEventListener('mousedown', handleTap);

        function timerLoop() {
            const count = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').innerText = timeLeft;
                if (timeLeft <= 0) { clearInterval(count); endGame(); }
            }, 1000);
        }

        function endGame() {
            gameActive = false;
            let reward = 0;
            if (score > 0) reward = 10; // Fixed: score > 0 now gives 10 tokens
            
            document.getElementById('menu').style.display = 'block';
            document.getElementById('finalScore').innerText = score;
            document.getElementById('athexEarned').innerText = reward + " ATHEX";
        }

        startGame();
    </script>
</body>
</html>
