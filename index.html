<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Professional Gradient Background */
        body { 
            margin: 0; 
            background: radial-gradient(circle, #1e3c72 0%, #2a5298 100%); 
            color: white; 
            text-align: center; 
            overflow: hidden; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            touch-action: none; 
        }
        canvas { display: block; margin: 0 auto; cursor: crosshair; }
        
        #ui { 
            position: absolute; top: 10px; width: 100%; pointer-events: none; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        #menu { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: rgba(0,0,0,0.85); padding: 30px; border-radius: 20px; 
            display: none; pointer-events: auto; border: 2px solid #0088cc;
            width: 80%;
        }

        button { 
            background: linear-gradient(to bottom, #0088cc, #005580); 
            color: white; border: none; padding: 15px 30px; 
            border-radius: 50px; font-size: 20px; font-weight: bold;
            cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .combo-text { color: #ffd700; font-size: 28px; font-weight: 900; }
        .reward-amt { color: #00ffcc; font-size: 32px; display: block; margin: 10px 0; }
    </style>
</head>
<body>
    <div id="ui">
        <h2 id="targetText">Target: <span id="colorName">LOADING...</span></h2>
        <div style="font-size: 18px;">Score: <span id="scoreVal">0</span> | Time: <span id="timer">15</span>s</div>
        <div id="comboDisplay" class="combo-text"></div>
    </div>

    <div id="menu">
        <h1 id="statusText">GAME OVER</h1>
        <p id="finalScoreDisplay">Your Score: 0</p>
        <div id="rewardSection">
            Tokens Earned: <span class="reward-amt" id="athexEarned">0 ATHEX</span>
        </div>
        <button onclick="startGame()">TRY AGAIN</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let score, timeLeft, objects, combo, gameActive, speedMultiplier;
        const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f1c40f']; // Blue, Red, Green, Yellow
        const colorNames = ['BLUE', 'RED', 'GREEN', 'YELLOW'];
        let targetIdx = 0;

        function drawLeaf(x, y, radius, color) {
            ctx.save();
            ctx.translate(x, y);
            ctx.fillStyle = color;
            ctx.beginPath();
            // Simple Leaf Shape Logic
            ctx.moveTo(0, -radius);
            ctx.quadraticCurveTo(radius, -radius, radius, 0);
            ctx.quadraticCurveTo(radius, radius, 0, radius);
            ctx.quadraticCurveTo(-radius, radius, -radius, 0);
            ctx.quadraticCurveTo(-radius, -radius, 0, -radius);
            ctx.fill();
            // Leaf Stem
            ctx.strokeStyle = "rgba(255,255,255,0.5)";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, -radius);
            ctx.lineTo(0, radius);
            ctx.stroke();
            ctx.restore();
        }

        function startGame() {
            score = 0; timeLeft = 15; objects = []; combo = 0; 
            gameActive = true; speedMultiplier = 1;
            targetIdx = Math.floor(Math.random() * colors.length);
            
            document.getElementById('colorName').innerText = colorNames[targetIdx];
            document.getElementById('colorName').style.color = colors[targetIdx];
            document.getElementById('menu').style.display = 'none';
            
            update();
            startTimer();
        }

        function update() {
            if (!gameActive) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Dynamic Difficulty: Speed increases as time runs out
            if (timeLeft < 10) speedMultiplier = 1.5;
            if (timeLeft < 5) speedMultiplier = 2.2;

            if (Math.random() < 0.04) {
                objects.push({
                    x: Math.random() * (canvas.width - 60) + 30,
                    y: -30,
                    colorIdx: Math.floor(Math.random() * colors.length),
                    radius: 25,
                    speed: (2 + Math.random() * 2) * speedMultiplier
                });
            }

            objects.forEach((obj, index) => {
                obj.y += obj.speed;
                drawLeaf(obj.x, obj.y, obj.radius, colors[obj.colorIdx]);

                if (obj.y > canvas.height + 40) {
                    if (obj.colorIdx === targetIdx) {
                        score = Math.max(0, score - 1); // Missed penalty
                        combo = 0;
                    }
                    objects.splice(index, 1);
                }
            });

            document.getElementById('scoreVal').innerText = score;
            document.getElementById('comboDisplay').innerText = combo >= 5 ? `X${Math.floor(combo/5) + 1} COMBO!` : "";
            requestAnimationFrame(update);
        }

        function handleInput(e) {
            if (!gameActive) return;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            objects.forEach((obj, index) => {
                const dist = Math.hypot(clientX - obj.x, clientY - obj.y);
                if (dist < obj.radius + 20) {
                    if (obj.colorIdx === targetIdx) {
                        combo++;
                        let mult = combo >= 10 ? 3 : (combo >= 5 ? 2 : 1);
                        score += (1 * mult);
                    } else {
                        score = Math.max(0, score - 2); 
                        combo = 0;
                    }
                    objects.splice(index, 1);
                }
            });
        }

        canvas.addEventListener('touchstart', handleInput);
        canvas.addEventListener('mousedown', handleInput);

        function startTimer() {
            const interval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').innerText = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(interval);
                    endGame();
                }
            }, 1000);
        }

        function endGame() {
            gameActive = false;
            let reward = 0;
            let status = "TRY AGAIN!";
            
            // WIN/LOSS LOGIC
            if (score >= 20) {
                reward = 10;
                status = "MISSION SUCCESS!";
            } else if (score >= 10) {
                reward = 5;
                status = "NOT BAD!";
            } else {
                reward = 0;
                status = "LEVEL FAILED!";
            }

            document.getElementById('menu').style.display = 'block';
            document.getElementById('statusText').innerText = status;
            document.getElementById('statusText').style.color = reward > 0 ? "#00ffcc" : "#ff4444";
            document.getElementById('finalScoreDisplay').innerText = "Final Score: " + score;
            document.getElementById('athexEarned').innerText = reward + " ATHEX";
        }

        startGame();
    </script>
</body>
</html>
